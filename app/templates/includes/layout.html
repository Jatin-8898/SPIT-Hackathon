<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="shortcut icon" href="/static/images/icon.png">
<!--     <link rel="stylesheet" href="/static/css/style.css" type="text/css" />
 -->    <link rel=" stylesheet" href="/static/css/bootstrap4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <title>BLOCK GRAIN</title>
</head>

<body>

    {% block body %}

    {% endblock %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.13.0/umd/popper.min.js"></script>
    <script src="/static/css/bootstrap4/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="/static/js/web3.min.js"></script>
    <script src="/static/js/main.js"></script>
    
    <script type="text/javascript">
        $(document).ready(function () {
            $("#status").show();
            $("#refresh").hide();


            initWeb3();

            $("#riceQuantity").keyup(function () {
                var quantity = parseInt($(this).val());
                if (!isNaN(quantity)) {
                    $("#riceTotalCost").text(quantity * 3);
                } else {
                    $("#riceTotalCost").text("0");
                }
            });

            $("#wheatQuantity").keyup(function () {
                var quantity = parseInt($(this).val());
                if (!isNaN(quantity)) {
                    $("#wheatTotalCost").text(quantity * 2);
                } else {
                    $("#wheatTotalCost").text("0");
                }
            });

            $("#coarseQuantity").keyup(function () {
                var quantity = parseInt($(this).val());
                if (!isNaN(quantity)) {
                    $("#coarseTotalCost").text(quantity * 1);
                } else {
                    $("#coarseTotalCost").text("0");
                }
            });

            $(".quantity").keyup(function () {
                var total = parseInt($("#riceTotalCost").text()) + parseInt($("#wheatTotalCost").text()) +
                    parseInt($(
                        "#coarseTotalCost").text());
                $("#grandTotal").text(total);
            });

            $("#confirmButton").click(function () {
                $.get("/sendOtp",function(data,status){
                    //console.log(data);
                });
                //performTransaction();
            });

            $("#submitOtp").click(function(){
                var otp = $("#inputOtp").val();
                 $.get("/verifyOtp/"+otp,function(data,status){
                    //console.log(data);
                    if(data === "True"){
                        //$('#exampleModal').modal('hide');
                        //$("#exampleModal").hide();
                        performTransaction();
                    }
                    else{

                    }
                });
            });

        });

        var contract, web3, distributor;
        var beneficiary = '0x2Fb5450D46267983331b42e49430bBF7474dB6d8';

        function initWeb3() {
            if (typeof web3 !== 'undefined') {
                provider = web3.currentProvider;
                provider.enable();
                web3 = new Web3(provider);
                web3.eth.getCoinbase((error, account) => {
                    distributor = account;
                    initContract();
                });
            }
        }

        function initContract() {
            $.getJSON('/static/build/contracts/Commodity.json', function (output) {
                abi = output.abi;
                contract = new web3.eth.Contract(abi, "0x88ba533e0b33f10b7153AF72479B1D095B89906a");
                contract.events.BufferStatusChanged({}, (err, result) => {
                    contract.methods.distributors(distributor).call((error, res) => {
                        $("#rice").text(res[0]);
                        $("#wheat").text(res[1]);
                        $("#coarse").text(res[2]);

                        $("#status").show();
                        $("#refresh").hide();
                    });
                });
                getStatus();
            });
        }

        function getStatus() {
            contract.methods.distributors(distributor).call((error, res) => {
                $("#rice").text(res[0]);
                $("#wheat").text(res[1]);
                $("#coarse").text(res[2]);
            });
        }

        function performTransaction() {
            var riceAmount = parseInt($("#riceQuantity").val());
            var wheatAmount = parseInt($("#wheatQuantity").val());
            var coarseAmount = parseInt($("#coarseQuantity").val());
            contract.methods.sell(beneficiary,"0x01","0x123456",riceAmount, wheatAmount, coarseAmount).send({
                from: distributor
            });
            $("#status").hide();
            $("#refresh").show();

        }
    </script>
    
</body>

</html>